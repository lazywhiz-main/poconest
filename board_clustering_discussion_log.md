# ボードクラスタリング機能改善 - 議論ログ

**開始日**: 2025年8月12日  
**参加者**: ユーザー、AI Assistant  
**目的**: クラスタリング・ラベリング・リレーション管理の改善設計

---

## 🎯 議論の発端

**ユーザーの課題認識**:
- クラスタリングがうまくいかない（塊が上手に作れない）
- ラベリングがもう少しブラッシュアップされると良い
- リレーションを削除する機能が欲しい（具体的体験は未検討）

**AI分析結果**:
- 現状実装の詳細調査完了
- 技術的課題とUX課題を分離して特定
- 改善優先度の整理

---

## 💬 主要議論ポイント

### 1. リレーション削除UI設計

**ユーザー要望**:
```
線を選択してハイライトされた状態で右クリック→削除、的な感じ
＋全リレーションを削除をどこかに配置したい
```

**設計方向性**:
- **個別削除**: エッジクリック → ハイライト → 右クリックメニュー → 削除確認
- **一括削除**: ツールバーまたはメニューに「全リレーション削除」機能
- **フィードバック**: 削除前のプレビュー、削除後の状態確認

**技術的検討事項**:
- SVGエッジのクリックイベント実装
- 右クリックコンテキストメニューの作成
- 削除確認ダイアログの設計
- リアルタイム更新（Supabase Realtime）

### 2. クラスタリング精度向上

**ユーザー要望**:
```
もう少し細かめに切りたい時もありそう
```

**課題分析**:
- 現在のDBSCANパラメータが固定的
- ユーザーの意図に応じた粒度調整ができない
- アルゴリズム選択が自動化されていない

**改善方向性**:
- **パラメータ調整UI**: スライダーでeps/minPtsを動的調整
- **プリセット**: 「細かく」「標準」「大きく」の3段階
- **リアルタイムプレビュー**: パラメータ変更時の即座反映
- **アルゴリズム推奨**: データ特性に応じた最適手法提案

### 3. ラベリング改善

**ユーザー要望**:
```
数単語からなる体言止めの文章になっているのも良いと思う
そしてラベル自体が編集できたり
```

**現状の課題**:
- キーワードレベルの単語ラベル
- 文脈を反映した自然な表現になっていない
- 手動編集機能がない

**改善方向性**:
- **文章形式ラベル**: 「〜に関する議論」「〜の検討事項」等
- **インライン編集**: ラベルダブルクリック → テキスト編集
- **提案機能**: AI による代替ラベル候補表示
- **保存機能**: カスタムラベルの永続化

### 4. ビュー保存・管理

**ユーザー要望**:
```
あるクラスタリングの状態のビューを保存しておいて、改めて表示したりできると嬉しい
```

**機能要件**:
- **ビュー保存**: クラスタリング結果 + ラベル + レイアウト
- **ビュー命名**: ユーザー定義の分かりやすい名前
- **ビュー切り替え**: 保存済みビューの一覧・選択
- **ビュー管理**: 編集・削除・コピー機能

**技術的検討**:
- 保存データ構造の設計
- Supabaseでの永続化
- レイアウト座標の保存
- バージョン管理の考慮

### 5. クラスター分析機能

**ユーザー要望**:
```
各クラスターに入っているカードをリストで見たり、
グラウンデッド・セオリー分析手法で、クラスター分析からシナリオを組み立てるようなことも
チャレンジしてみたいと思っている
```

**グラウンデッド・セオリー手法**:
- **オープンコーディング**: 各カードの概念抽出
- **軸足コーディング**: クラスター間の関係性分析  
- **選択的コーディング**: 中核概念の特定
- **理論構築**: シナリオ・仮説の組み立て

**機能設計方向性**:
- **クラスター詳細ビュー**: カード一覧 + 統計情報
- **概念抽出**: AIによるキーワード・テーマ分析
- **関係性マップ**: クラスター間の論理的関係
- **シナリオジェネレーター**: AIによる仮説・物語生成

---

## 🔄 議論の進行状況

### Phase 1: 現状分析 ✅ 完了
- [x] 既存実装の詳細調査
- [x] 技術的課題の特定
- [x] UX課題の整理
- [x] 現状分析ドキュメント作成

### Phase 2: 要件定義 🔄 進行中
- [x] ユーザー要望の整理
- [x] 機能要件の抽出
- [ ] 技術要件の詳細化
- [ ] 優先度・工数の見積もり

### Phase 3: 設計 📋 計画中
- [ ] UI/UXモックアップ
- [ ] データ構造設計
- [ ] API設計
- [ ] 実装計画

### Phase 4: 実装 ⏰ 未着手
- [ ] 優先機能の実装
- [ ] テスト・検証
- [ ] ユーザーフィードバック
- [ ] 反復改善

---

## 🤔 未解決の議論ポイント

### 1. 優先順位の決定
**検討課題**: どの機能から実装すべきか？
- リレーション削除UI（すぐに効果的）
- クラスタリング精度（根本的改善）
- ラベル編集（ユーザビリティ）
- ビュー保存（長期利用価値）

### 2. グラウンデッド・セオリー実装の深度
**検討課題**: どこまでAI支援するか？
- 概念抽出の自動化レベル
- ユーザーの手動入力との balance
- シナリオ生成の品質担保

### 3. パフォーマンス vs 機能性
**検討課題**: 複雑な分析と応答性のバランス
- リアルタイム計算の限界
- バックグラウンド処理の設計
- プログレッシブ表示の採用

### 4. データ構造の拡張
**検討課題**: 新機能のためのDB設計
- ビュー保存のスキーマ
- カスタムラベルの管理
- 分析結果の履歴保持

### 5. ノード密度管理 **NEW**
**検討課題**: 視認性とパフォーマンスのバランス
- 動的領域サイズ調整の実装方法
- 最適密度の閾値設定
- 大規模データでの描画パフォーマンス
- ズーム・パン操作との連携

---

## 💡 浮上したアイデア

### 1. インタラクティブクラスタリング
- ユーザーによる手動グルーピング
- ドラッグ&ドロップでクラスター編集
- AI提案 + 人間判断のハイブリッド

### 2. 学習型システム
- ユーザーの編集履歴から学習
- パーソナライズされたクラスタリング
- 組織・チーム単位での最適化

### 3. 外部ツール連携
- Miro/FigJam等への出力
- Excel/CSV エクスポート
- プレゼン資料自動生成

### 4. 分析レポート機能
- クラスター分析結果の文書化
- 時系列での変化追跡
- インサイト抽出の自動化

---

## 📋 次回議論予定

### 1. 設計要件の確定
- UI/UX の具体的モックアップ
- データフロー・状態管理の設計
- エラーハンドリング・エッジケース

### 2. 実装計画の策定
- 開発フェーズの分割
- 各機能の工数見積もり
- リリース計画

### 3. 技術的詳細の決定
- ライブラリ・フレームワーク選択
- パフォーマンス最適化戦略
- テスト・品質保証方針

---

**最終更新**: 2025年1月12日  
**次回議論**: Phase 1 実装計画の詳細化（パネル改善を最優先）  
**ステータス**: 密度管理・パネル改善要件統合完了 - 実装準備段階

---

## 🆕 最新の議論追加（密度管理）

### 6. ノード密度・視認性の改善

**ユーザー課題**:
```
ノード密度が高すぎると醜いので、ノードの数が増えると使っている領域も増えて、
みやすい密度を維持してほしい
```

**現状分析結果**:
- 固定サイズ（4800x3600px）により高密度時の視認性悪化
- ノード配置アルゴリズムでのオーバーラップ発生
- ズーム・パン操作の最適化不足

**改善方向性**:
1. **動的領域拡張**: ノード数に応じた描画領域の自動調整
2. **最適密度維持**: 物理シミュレーションによる適切な間隔保持
3. **スマートナビゲーション**: 自動ズーム・フォーカス機能

**優先度**: 🔴 High → Phase 1 に組み込み

**技術検討事項**:
- 密度計算アルゴリズムの設計
- パフォーマンスとの両立方法
- レスポンシブ対応の実装

---

## 🆕 最新の議論追加（ノード詳細パネル改善）

### 7. ノードクリック時の詳細パネル改善

**ユーザー課題**:
```
ノードクリック時にカードの中身と関連性リストがパネルとして表示されるが、
スクロールできないのと、もう少しユーザビリティ改善の余地がありそう
```

**現状の問題分析**:
| **問題カテゴリ** | **具体的課題** | **影響** |
|----------------|--------------|----------|
| **スクロール** | `maxHeight` 未設定 | 関連性多数時に画面外溢れ |
| **レスポンシブ** | 固定幅380px | 小画面で使いにくい |
| **操作性** | 関連カードクリック不可 | 効率的な探索不可 |
| **関連性管理** | 削除・編集機能なし | 不要な関係の整理不可 |

**改善方向性**:
1. **スクロール対応**: パネル高さ制限 + 縦スクロール機能
2. **インタラクティブ関連性リスト**: クリック移動 + 右クリックメニュー
3. **レスポンシブ設計**: 画面サイズに応じた幅調整
4. **情報階層最適化**: 重要情報の優先表示

**実装ファイル**: `src/features/nest-space/analysis-space/components/NetworkVisualization.tsx` (4673-4811行)

**優先度**: 🔴 High → Phase 1 に密度管理と併せて実装

**体験シナリオ**: 15個の関連性を持つカードでの効率的な詳細確認・整理

---

## 🚀 実装中の追加機能発見（関連性フィルター分離改善）

### 8. グローバル関連性フィルターの必要性

**ユーザーフィードバック**:
```
フィルター機能だが、各カードごとというよりは、分析スペース全体に対しての方が良いんじゃないかな。
左下にFilters領域があるが、これはノードのフィルターになっていると思うので、
この領域に追加していくことで、マップに表示されているノードや線をフィルターできるようになっていると嬉しい。
ソートは、今のままカード内のところでOK！
```

**課題認識**:
- カード詳細パネル内のフィルターは局所的すぎる
- ネットワーク全体の見通しを良くするグローバルフィルターが必要
- 既存のFilters領域（Tags、Type）との一貫性が重要

**実装された解決策**:

#### **グローバル関連性フィルター** (REL-005)
- **配置**: 左下Filters領域に「Relationships」セクション追加
- **機能**: ネットワーク全体の関連性タイプ別フィルタリング
- **対象タイプ**: Manual/Semantic/Derived/Tags/AI
- **視覚デザイン**: 各タイプ専用のアイコンと色分け（👥/🧠/🔗/🏷️/🤖）
- **操作性**: 複数タイプの組み合わせ選択可能

#### **ローカルソート機能への分離** (REL-004)
- **配置**: カード詳細パネル内はソート機能のみに特化
- **機能**: デフォルト/強度/タイプ/カード名順のソート
- **UI改善**: フィルター除去により操作がシンプル化

**技術実装のポイント**:
```typescript
// グローバルフィルター: ネットワーク全体のエッジ生成時に適用
const edges: NetworkEdge[] = relationships.filter(rel => 
  (activeFilters.relationships.length === 0 || 
   activeFilters.relationships.includes(rel.relationship_type))
);

// ローカルソート: カード詳細パネル内でのリスト整理のみ
const getSortedAndFilteredConnections = useCallback((connections) => {
  let sortedConnections = [...connections]; // フィルターは除去
  // ソートロジックのみ実装
}, [relationsSortBy, relationsSortOrder]);
```

**ユーザー体験の改善**:
1. **段階的分析**: AI提案→手動追加→意味的関係の順でフィルタリング
2. **視覚的クリア**: 不要な関係性を非表示化してネットワーク理解向上
3. **操作分離**: グローバル制御 vs ローカル整理の明確な役割分担

**優先度**: 🔴 High → Phase 2 実装に追加・完了

**期待効果**: 
- 複雑なネットワークでの段階的な関係性分析が可能
- データの質に応じた柔軟な表示制御
- 分析者の思考プロセスに沿った機能配置
