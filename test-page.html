<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³å£°æ–‡å­—èµ·ã“ã—ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ éŸ³å£°æ–‡å­—èµ·ã“ã—ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
        
        <div class="status info">
            ğŸ“‹ æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™
        </div>

        <div class="test-section">
            <h3>1. ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ</h3>
            <p>3ç§’é–“ã®ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ440Hzæ­£å¼¦æ³¢ï¼‰ã‚’ä½œæˆã—ã¾ã™</p>
            <button onclick="createTestAudioFile()">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ</button>
            <div id="audio-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>2. å®Ÿéš›ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</h3>
            <p>GCSç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨æ–‡å­—èµ·ã“ã—ã‚¸ãƒ§ãƒ–é–‹å§‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
            <button onclick="testRealAudioUpload()">å®Ÿéš›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
            <div id="upload-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆ</h3>
            <p>TranscriptionServiceV2ã¨GCSUploadServiceã®çµ±åˆãƒ†ã‚¹ãƒˆ</p>
            <button onclick="testFrontendIntegration()">ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆ</button>
            <div id="frontend-log" class="log"></div>
        </div>

        <div class="test-section">
            <h3>4. çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰</h3>
            <p>Cloud Runã¨Edge Functionã®çµ±åˆãƒ†ã‚¹ãƒˆ</p>
            <button onclick="testBackendIntegration()">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆ</button>
            <div id="backend-log" class="log"></div>
        </div>
    </div>

    <script>
        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function logToElement(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const originalLog = console.log;
        const originalError = console.error;
        
        function captureLog(elementId) {
            console.log = function(...args) {
                originalLog.apply(console, args);
                logToElement(elementId, args.join(' '));
            };
            console.error = function(...args) {
                originalError.apply(console, args);
                logToElement(elementId, 'âŒ ' + args.join(' '));
            };
        }

        function restoreLog() {
            console.log = originalLog;
            console.error = originalError;
        }

        // 1. ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        async function createTestAudioFile() {
            const logId = 'audio-log';
            document.getElementById(logId).textContent = '';
            captureLog(logId);
            
            try {
                console.log('ğŸ”§ [Test Audio] ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆé–‹å§‹');
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const sampleRate = 16000;
                const duration = 3;
                const numSamples = sampleRate * duration;
                
                const audioBuffer = audioContext.createBuffer(1, numSamples, sampleRate);
                const channelData = audioBuffer.getChannelData(0);
                
                const frequency = 440;
                for (let i = 0; i < numSamples; i++) {
                    channelData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.1;
                }
                
                const wavBlob = audioBufferToWav(audioBuffer);
                const url = URL.createObjectURL(wavBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test-audio.wav';
                a.click();
                
                URL.revokeObjectURL(url);
                
                console.log('ğŸ”§ [Test Audio] ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†');
                
            } catch (error) {
                console.error('ğŸ”§ [Test Audio] ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                restoreLog();
            }
        }

        // 2. å®Ÿéš›ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
        async function testRealAudioUpload() {
            const logId = 'upload-log';
            document.getElementById(logId).textContent = '';
            captureLog(logId);
            
            try {
                console.log('ğŸ”§ [Real Audio Test] å®Ÿéš›ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                // ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                const audioBlob = await createTestAudioBlob();
                const file = new File([audioBlob], 'test-audio.wav', { type: 'audio/wav' });
                
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                
                // ç½²åä»˜ãURLå–å¾—ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
                console.log('ç½²åä»˜ãURLå–å¾—ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                console.log('GCSã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                console.log('æ–‡å­—èµ·ã“ã—ã‚¸ãƒ§ãƒ–é–‹å§‹ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const jobId = `test_job_${Date.now()}`;
                console.log('æ–‡å­—èµ·ã“ã—ã‚¸ãƒ§ãƒ–é–‹å§‹æˆåŠŸ:', { jobId });
                
                console.log('ğŸ”§ [Real Audio Test] ãƒ†ã‚¹ãƒˆå®Œäº†');
                
            } catch (error) {
                console.error('ğŸ”§ [Real Audio Test] ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                restoreLog();
            }
        }

        // 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆ
        async function testFrontendIntegration() {
            const logId = 'frontend-log';
            document.getElementById(logId).textContent = '';
            captureLog(logId);
            
            try {
                console.log('ğŸ”§ [Frontend Test] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                // ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                const audioBlob = await createTestAudioBlob();
                const file = new File([audioBlob], 'test-audio-frontend.wav', { type: 'audio/wav' });
                
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                
                // TranscriptionServiceV2ãƒ¢ãƒƒã‚¯
                console.log('TranscriptionServiceV2.transcribeAudio å‘¼ã³å‡ºã—');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const jobId = `frontend_job_${Date.now()}`;
                console.log('é€šå¸¸ã®æ–‡å­—èµ·ã“ã—çµæœ:', { success: true, jobId });
                
                // é€²æ—ä»˜ããƒ†ã‚¹ãƒˆ
                console.log('é€²æ—ä»˜ãæ–‡å­—èµ·ã“ã—ãƒ†ã‚¹ãƒˆ');
                for (let i = 0; i <= 100; i += 10) {
                    console.log(`é€²æ—: ${i}%`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const progressJobId = `frontend_progress_job_${Date.now()}`;
                console.log('é€²æ—ä»˜ãæ–‡å­—èµ·ã“ã—çµæœ:', { success: true, jobId: progressJobId });
                
                console.log('ğŸ”§ [Frontend Test] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†');
                
            } catch (error) {
                console.error('ğŸ”§ [Frontend Test] ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                restoreLog();
            }
        }

        // 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆ
        async function testBackendIntegration() {
            const logId = 'backend-log';
            document.getElementById(logId).textContent = '';
            captureLog(logId);
            
            try {
                console.log('ğŸ§ª [Backend Test] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                const CLOUD_RUN_URL = 'https://transcription-service-753651631159.asia-northeast1.run.app/transcribe';
                const API_KEY = 'eRJn5wte3dPKJp3/MQG/SPtwTnaMcNo/1tg5/08MEeM=';
                const SUPABASE_URL = 'https://ecqkfcgtmabtfozfcvfr.supabase.co';
                
                // 1. æ–‡å­—èµ·ã“ã—ã‚¸ãƒ§ãƒ–é–‹å§‹
                console.log('1. æ–‡å­—èµ·ã“ã—ã‚¸ãƒ§ãƒ–é–‹å§‹ãƒ†ã‚¹ãƒˆ');
                const jobResponse = await fetch(CLOUD_RUN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY,
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        fileUrl: 'https://example.com/test-audio.mp3',
                        meetingId: 'test-meeting-backend',
                        nestId: 'test-nest-backend',
                        useGoogleCloud: true,
                        callbackUrl: `${SUPABASE_URL}/functions/v1/transcription-complete`
                    })
                });

                console.log('ã‚¸ãƒ§ãƒ–é–‹å§‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', jobResponse.status);
                
                if (!jobResponse.ok) {
                    const errorText = await jobResponse.text();
                    console.error('ã‚¸ãƒ§ãƒ–é–‹å§‹ã‚¨ãƒ©ãƒ¼:', errorText);
                    return;
                }

                const jobResult = await jobResponse.json();
                console.log('ã‚¸ãƒ§ãƒ–é–‹å§‹æˆåŠŸ:', jobResult);
                
                const jobId = jobResult.jobId;
                console.log('ç”Ÿæˆã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ID:', jobId);
                
                // 2. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆæ¨¡æ“¬ï¼‰
                console.log('2. ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆæ¨¡æ“¬ï¼‰');
                const callbackResponse = await fetch(`${SUPABASE_URL}/functions/v1/transcription-complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'apikey': API_KEY
                    },
                    body: JSON.stringify({
                        jobId: jobId,
                        meetingId: 'test-meeting-backend',
                        nestId: 'test-nest-backend',
                        status: 'success',
                        transcript: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆç”¨ã®æ–‡å­—èµ·ã“ã—çµæœã§ã™ã€‚',
                        speakers: [],
                        utterances: []
                    })
                });

                console.log('ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', callbackResponse.status);
                
                if (callbackResponse.ok) {
                    const callbackResult = await callbackResponse.json();
                    console.log('ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ:', callbackResult);
                } else {
                    const errorText = await callbackResponse.text();
                    console.error('ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', errorText);
                }

                console.log('ğŸ§ª [Backend Test] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†');

            } catch (error) {
                console.error('ğŸ§ª [Backend Test] ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                restoreLog();
            }
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function createTestAudioBlob() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = 16000;
            const duration = 2;
            const numSamples = sampleRate * duration;
            
            const audioBuffer = audioContext.createBuffer(1, numSamples, sampleRate);
            const channelData = audioBuffer.getChannelData(0);
            
            const frequency = 440;
            for (let i = 0; i < numSamples; i++) {
                channelData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate) * 0.1;
            }
            
            return audioBufferToWav(audioBuffer);
        }

        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const numberOfChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
            const view = new DataView(arrayBuffer);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * numberOfChannels * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numberOfChannels * 2, true);
            view.setUint16(32, numberOfChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * numberOfChannels * 2, true);
            
            let offset = 44;
            for (let i = 0; i < length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        console.log('ğŸ¤ ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼');
        console.log('ğŸ“‹ ä¸Šè¨˜ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
    </script>
</body>
</html>
